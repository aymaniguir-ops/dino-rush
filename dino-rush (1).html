<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f0f1a">
<title>DINO RUSH</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800;900&family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
html,body{width:100%;height:100%;overflow:hidden;background:#0f0f1a;font-family:'Nunito',sans-serif;touch-action:none}

:root{
  --green:#39FF6E;
  --green2:#00c44f;
  --red:#FF3E6C;
  --yellow:#FFD93D;
  --blue:#4FC3F7;
  --purple:#B388FF;
  --bg:#0f0f1a;
  --card:#1a1a2e;
  --card2:#22223a;
  --border:rgba(255,255,255,0.08);
  --text:#F0F0FF;
  --sub:#8888aa;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

/* â”€â”€ SCREENS â”€â”€ */
#app{position:fixed;inset:0;display:flex;flex-direction:column;overflow:hidden}

.screen{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;overflow:hidden}
.screen.active{display:flex}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#homeScreen{
  background:radial-gradient(ellipse at 50% 30%, #1a1a40 0%, #0f0f1a 70%);
  justify-content:center;gap:0;
}

.home-bg-grid{
  position:absolute;inset:0;
  background-image:linear-gradient(rgba(57,255,110,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(57,255,110,0.04) 1px,transparent 1px);
  background-size:40px 40px;
  mask-image:radial-gradient(ellipse at center,black 30%,transparent 80%);
}

.home-glow{
  position:absolute;top:-100px;left:50%;transform:translateX(-50%);
  width:400px;height:400px;border-radius:50%;
  background:radial-gradient(circle,rgba(57,255,110,0.12) 0%,transparent 70%);
  pointer-events:none;
}

.home-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:32px;padding:40px 24px;width:100%;max-width:480px}

/* Dino mascot */
.mascot-wrap{position:relative;width:120px;height:120px;margin:0 auto}
#mascotCanvas{image-rendering:pixelated}

.mascot-shadow{
  position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
  width:70px;height:12px;border-radius:50%;
  background:rgba(57,255,110,0.2);
  filter:blur(6px);
  animation:shadowPulse 1.2s ease-in-out infinite;
}
@keyframes shadowPulse{0%,100%{width:70px;opacity:.6}50%{width:50px;opacity:.3}}

.mascot-wrap{animation:mascotFloat 1.8s ease-in-out infinite}
@keyframes mascotFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

/* Title */
.title-block{text-align:center}
.game-title{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(24px,7vw,40px);
  color:var(--green);
  text-shadow:0 0 30px rgba(57,255,110,0.6),0 0 60px rgba(57,255,110,0.3);
  letter-spacing:4px;
  line-height:1.2;
}
.game-sub{
  font-size:12px;letter-spacing:4px;color:var(--sub);text-transform:uppercase;margin-top:8px;font-weight:700;
}

/* Best score pill */
.best-pill{
  display:flex;align-items:center;gap:10px;
  background:rgba(255,217,61,0.08);
  border:1px solid rgba(255,217,61,0.2);
  border-radius:100px;padding:10px 20px;
}
.best-pill .trophy{font-size:20px}
.best-pill .best-label{font-size:11px;color:var(--sub);font-weight:700;letter-spacing:2px}
.best-pill .best-val{font-family:'Press Start 2P',monospace;font-size:14px;color:var(--yellow)}

/* Home buttons */
.home-buttons{display:flex;flex-direction:column;gap:12px;width:100%}

.btn-play{
  width:100%;padding:20px;border-radius:18px;border:none;cursor:pointer;
  background:linear-gradient(135deg,#39FF6E,#00c44f);
  color:#0a1a0f;font-family:'Nunito',sans-serif;font-weight:900;font-size:18px;
  letter-spacing:2px;text-transform:uppercase;
  box-shadow:0 8px 30px rgba(57,255,110,0.4),0 2px 0 rgba(0,0,0,0.3);
  transition:transform .12s,box-shadow .12s;
  position:relative;overflow:hidden;
}
.btn-play::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.15) 0%,transparent 60%)}
.btn-play:active{transform:scale(.97) translateY(2px);box-shadow:0 4px 20px rgba(57,255,110,0.3),0 0 0 rgba(0,0,0,0.3)}
.btn-play-icon{font-size:22px;margin-right:8px}

.home-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.btn-secondary{
  width:100%;padding:16px;border-radius:16px;border:1.5px solid var(--border);cursor:pointer;
  background:var(--card);color:var(--text);font-family:'Nunito',sans-serif;font-weight:800;font-size:14px;
  display:flex;flex-direction:column;align-items:center;gap:6px;
  transition:all .15s;
}
.btn-secondary:active{transform:scale(.96);background:var(--card2)}
.btn-secondary .ico{font-size:24px}
.btn-secondary .lbl{font-size:12px;letter-spacing:1px;color:var(--sub)}

/* Coins badge */
.coins-badge{
  display:flex;align-items:center;gap:8px;
  background:rgba(255,217,61,0.08);border:1px solid rgba(255,217,61,0.15);
  border-radius:12px;padding:8px 16px;font-weight:800;
}
.coins-badge .coin-ico{font-size:18px}
.coins-badge .coin-amt{color:var(--yellow);font-size:16px}
.coins-badge .coin-lbl{color:var(--sub);font-size:11px;letter-spacing:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#gameScreen{background:#0f0f1a;justify-content:flex-start}

/* Top HUD */
.game-hud{
  width:100%;padding:12px 16px 8px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
  padding-top:max(12px, env(safe-area-inset-top, 12px));
}

.hud-score{
  font-family:'Press Start 2P',monospace;
  font-size:clamp(14px,4vw,20px);color:var(--text);
  text-shadow:0 0 20px rgba(255,255,255,0.3);
}
.hud-score .hud-label{font-size:8px;color:var(--sub);display:block;margin-bottom:4px;letter-spacing:2px}

.hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px}
.hud-hi{font-size:10px;color:var(--yellow);font-weight:800;letter-spacing:1px}

.lives-row{display:flex;gap:5px;align-items:center}
.life-heart{font-size:16px;transition:all .3s;filter:drop-shadow(0 0 4px #ff3e6c)}
.life-heart.lost{filter:none;opacity:0.2}

/* Canvas area */
.canvas-container{
  flex:1;width:100%;position:relative;overflow:hidden;
  min-height:0;
}
#gameCanvas{width:100%;height:100%;display:block;image-rendering:pixelated}

/* Powerup HUD overlay */
.powerup-overlay{
  position:absolute;top:10px;right:12px;
  display:flex;gap:6px;
}
.pu-badge{
  width:36px;height:36px;border-radius:10px;
  background:rgba(15,15,26,0.8);border:1.5px solid transparent;
  display:flex;align-items:center;justify-content:center;font-size:16px;
  opacity:0.25;transition:all .3s;
  position:relative;overflow:hidden;
  backdrop-filter:blur(6px);
}
.pu-badge.active{opacity:1;border-color:var(--green);box-shadow:0 0 12px rgba(57,255,110,0.4)}
.pu-timer{position:absolute;bottom:0;left:0;height:3px;background:var(--green);transition:width .1s linear;border-radius:0 0 2px 2px}

/* Speed indicator */
.speed-bar{
  position:absolute;top:10px;left:12px;
  background:rgba(15,15,26,0.8);border:1px solid var(--border);
  border-radius:10px;padding:6px 10px;font-size:10px;
  backdrop-filter:blur(6px);
  display:flex;flex-direction:column;gap:2px;
}
.speed-label{color:var(--sub);letter-spacing:2px;font-size:8px;font-weight:700}
.speed-val{color:var(--green);font-weight:900;font-size:13px}

/* Combo popup */
.combo-float{
  position:absolute;left:50%;transform:translateX(-50%);
  font-family:'Press Start 2P',monospace;font-size:14px;
  pointer-events:none;z-index:30;white-space:nowrap;
  animation:floatUp .8s forwards cubic-bezier(.2,1,.5,1);
}
@keyframes floatUp{0%{opacity:1;transform:translateX(-50%) translateY(0) scale(.8)}100%{opacity:0;transform:translateX(-50%) translateY(-50px) scale(1.2)}}

/* â”€â”€ OVERLAY PANELS â”€â”€ */
.game-overlay{
  position:absolute;inset:0;
  background:rgba(10,10,20,0.88);
  backdrop-filter:blur(12px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:20px;z-index:20;
  opacity:0;pointer-events:none;transition:opacity .25s;
}
.game-overlay.show{opacity:1;pointer-events:all}

.overlay-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:24px;
  padding:32px 28px;
  width:calc(100% - 48px);max-width:380px;
  text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.6);
  animation:cardIn .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes cardIn{from{transform:scale(.85) translateY(20px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}

.overlay-icon{font-size:48px;margin-bottom:8px;display:block}
.overlay-title{font-family:'Press Start 2P',monospace;font-size:20px;line-height:1.4}
.overlay-title.green{color:var(--green);text-shadow:0 0 20px rgba(57,255,110,.5)}
.overlay-title.red{color:var(--red);text-shadow:0 0 20px rgba(255,62,108,.5)}

.overlay-score{
  font-family:'Press Start 2P',monospace;font-size:28px;
  color:var(--yellow);margin:16px 0 8px;
  text-shadow:0 0 20px rgba(255,217,61,.4);
}
.overlay-sub{font-size:13px;color:var(--sub);font-weight:700;letter-spacing:1px}
.new-record{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(255,217,61,0.1);border:1px solid rgba(255,217,61,0.3);
  border-radius:100px;padding:6px 14px;font-size:12px;color:var(--yellow);
  font-weight:800;margin-top:8px;
}

/* START hint */
.tap-hint{
  font-family:'Press Start 2P',monospace;font-size:11px;
  color:var(--green);letter-spacing:2px;
  animation:blink 1.1s step-end infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* â”€â”€ JUMP & DUCK CONTROLS â”€â”€ */
.controls-bar{
  width:100%;padding:12px 16px;
  padding-bottom:max(16px, calc(env(safe-area-inset-bottom, 0px) + 12px));
  display:grid;grid-template-columns:1fr 1fr;gap:12px;
  flex-shrink:0;background:rgba(15,15,26,0.95);
  border-top:1px solid var(--border);
  position:relative;z-index:10;
}

.ctrl-btn{
  border-radius:18px;border:none;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
  transition:transform .1s,box-shadow .1s;
  -webkit-tap-highlight-color:transparent;
  position:relative;overflow:hidden;
}
.ctrl-btn::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(255,255,255,0.12) 0%,transparent 50%);
  border-radius:inherit;pointer-events:none;
}

.ctrl-btn:active{transform:scale(.94)}

.btn-jump{
  background:linear-gradient(145deg,#2ECC71,#1aa355);
  box-shadow:0 6px 0 #0f6b35,0 8px 20px rgba(46,204,113,0.35);
  padding:18px 16px 22px;
}
.btn-jump:active{box-shadow:0 2px 0 #0f6b35,0 4px 12px rgba(46,204,113,0.25);transform:scale(.94) translateY(4px)}

.btn-duck{
  background:linear-gradient(145deg,#3B82F6,#1d4ed8);
  box-shadow:0 6px 0 #1030a0,0 8px 20px rgba(59,130,246,0.35);
  padding:18px 16px 22px;
}
.btn-duck:active{box-shadow:0 2px 0 #1030a0,0 4px 12px rgba(59,130,246,0.25);transform:scale(.94) translateY(4px)}

.ctrl-icon{font-size:32px;pointer-events:none;display:block}
.ctrl-label{
  font-family:'Nunito',sans-serif;font-weight:900;font-size:11px;
  letter-spacing:2px;text-transform:uppercase;pointer-events:none;
}
.btn-jump .ctrl-label{color:rgba(10,30,15,0.8)}
.btn-duck .ctrl-label{color:rgba(10,20,50,0.8)}

/* Pause button */
.pause-btn{
  position:absolute;bottom:calc(100% + 10px);right:16px;
  width:40px;height:40px;border-radius:12px;border:1.5px solid var(--border);
  background:var(--card);color:var(--sub);font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;z-index:11;
}
.pause-btn:active{background:var(--card2);transform:scale(.93)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#shopScreen{
  background:var(--bg);
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}

.shop-header{
  width:100%;display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;
  padding-top:max(16px, env(safe-area-inset-top, 16px));
  background:rgba(15,15,26,0.95);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;
  backdrop-filter:blur(12px);
  flex-shrink:0;
}
.shop-title{font-family:'Press Start 2P',monospace;font-size:14px;color:var(--text)}
.back-btn{
  width:38px;height:38px;border-radius:10px;border:1.5px solid var(--border);
  background:var(--card);color:var(--text);font-size:18px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .15s;
}
.back-btn:active{transform:scale(.9)}
.shop-coins{
  display:flex;align-items:center;gap:6px;
  background:rgba(255,217,61,0.1);border:1px solid rgba(255,217,61,0.2);
  border-radius:100px;padding:8px 14px;font-weight:800;
}
.shop-coins .sc-ico{font-size:16px}
.shop-coins .sc-amt{color:var(--yellow);font-size:15px}

.shop-body{width:100%;padding:16px;display:flex;flex-direction:column;gap:20px;max-width:600px;margin:0 auto}

.shop-section h2{
  font-size:11px;letter-spacing:3px;color:var(--sub);text-transform:uppercase;
  font-weight:800;margin-bottom:12px;padding-left:4px;
}

.skins-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:400px){.skins-grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:560px){.skins-grid{grid-template-columns:repeat(4,1fr)}}

.skin-tile{
  background:var(--card);border:2px solid var(--border);border-radius:18px;
  padding:14px 10px 10px;display:flex;flex-direction:column;align-items:center;gap:8px;
  cursor:pointer;transition:all .18s;position:relative;overflow:hidden;
}
.skin-tile::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(255,255,255,0.04) 0%,transparent 40%);
  border-radius:inherit;pointer-events:none;
}
.skin-tile.equipped{border-color:var(--green);background:rgba(57,255,110,0.06);box-shadow:0 0 20px rgba(57,255,110,0.15)}
.skin-tile.selected-preview{border-color:var(--blue);background:rgba(79,195,247,0.06)}
.skin-tile:active{transform:scale(.95)}
.skin-tile.locked{cursor:default}

.skin-canvas-wrap{width:60px;height:55px;display:flex;align-items:center;justify-content:center}
.skin-preview-canvas{image-rendering:pixelated;display:block}

.skin-name{font-size:10px;font-weight:800;letter-spacing:1px;color:var(--text);text-align:center;line-height:1.3}
.skin-price{font-size:11px;font-weight:800;color:var(--yellow)}

.rarity-pip{
  position:absolute;top:8px;right:8px;
  width:7px;height:7px;border-radius:50%;
}
.rarity-pip.common{background:#888}
.rarity-pip.rare{background:#4FC3F7;box-shadow:0 0 6px #4FC3F7}
.rarity-pip.epic{background:#B388FF;box-shadow:0 0 6px #B388FF}
.rarity-pip.legendary{background:#FFD93D;box-shadow:0 0 8px #FFD93D;animation:legPulse 1s ease-in-out infinite}
@keyframes legPulse{0%,100%{box-shadow:0 0 6px #FFD93D}50%{box-shadow:0 0 14px #FFD93D}}

.equipped-badge{
  position:absolute;bottom:6px;left:50%;transform:translateX(-50%);
  background:var(--green);color:#0a1a0f;font-size:8px;font-weight:900;
  letter-spacing:1px;border-radius:100px;padding:2px 8px;white-space:nowrap;
}
.lock-overlay{
  position:absolute;inset:0;background:rgba(10,10,20,0.7);
  display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
  padding-bottom:10px;gap:4px;border-radius:16px;
  backdrop-filter:blur(2px);
}
.lock-ico{font-size:20px}
.lock-price{font-size:11px;font-weight:900;color:var(--yellow)}

.buy-confirm{
  position:fixed;inset:0;z-index:100;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);
  display:none;align-items:flex-end;justify-content:center;
  padding-bottom:max(20px, env(safe-area-inset-bottom, 20px));
}
.buy-confirm.show{display:flex}
.buy-sheet{
  background:var(--card);border:1px solid var(--border);
  border-radius:28px 28px 20px 20px;
  padding:28px 24px;width:100%;max-width:480px;
  display:flex;flex-direction:column;gap:16px;
  animation:sheetUp .25s cubic-bezier(.34,1.56,.64,1);
}
@keyframes sheetUp{from{transform:translateY(60px);opacity:0}to{transform:translateY(0);opacity:1}}
.buy-sheet h3{font-size:18px;font-weight:900;text-align:center}
.buy-sheet .buy-preview{display:flex;justify-content:center}
.buy-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.buy-cancel{
  padding:15px;border-radius:14px;border:1.5px solid var(--border);
  background:var(--card2);color:var(--sub);font-size:14px;font-weight:800;
  cursor:pointer;font-family:'Nunito',sans-serif;transition:all .15s;
}
.buy-cancel:active{transform:scale(.95)}
.buy-confirm-btn{
  padding:15px;border-radius:14px;border:none;
  background:linear-gradient(135deg,var(--yellow),#ffaa00);
  color:#2a1500;font-size:14px;font-weight:900;
  cursor:pointer;font-family:'Nunito',sans-serif;
  box-shadow:0 4px 0 #a06800;
  transition:all .15s;
}
.buy-confirm-btn:active{transform:scale(.95) translateY(2px);box-shadow:0 2px 0 #a06800}

/* Trail items */
.trails-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
@media(min-width:400px){.trails-grid{grid-template-columns:repeat(3,1fr)}}

.trail-tile{
  background:var(--card);border:2px solid var(--border);border-radius:16px;
  padding:14px 12px;display:flex;flex-direction:column;align-items:center;gap:8px;
  cursor:pointer;transition:all .18s;position:relative;overflow:hidden;
}
.trail-tile.equipped{border-color:var(--red);background:rgba(255,62,108,0.06);box-shadow:0 0 20px rgba(255,62,108,0.15)}
.trail-tile:active{transform:scale(.95)}
.trail-tile.locked{cursor:default}

.trail-dots-preview{display:flex;align-items:center;gap:4px;height:32px}
.t-dot{border-radius:50%;animation:tdot 1s ease-in-out infinite}
@keyframes tdot{0%,100%{opacity:.25;transform:scale(.6)}50%{opacity:1;transform:scale(1)}}
.trail-name-small{font-size:10px;font-weight:800;color:var(--text);letter-spacing:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS / PROFILE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settingsScreen{background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch}
.settings-header{
  width:100%;display:flex;align-items:center;justify-content:space-between;
  padding:16px 20px;
  padding-top:max(16px, env(safe-area-inset-top, 16px));
  background:rgba(15,15,26,0.95);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;backdrop-filter:blur(12px);flex-shrink:0;
}
.settings-title{font-family:'Press Start 2P',monospace;font-size:12px;color:var(--text)}
.settings-body{width:100%;padding:16px;display:flex;flex-direction:column;gap:12px;max-width:600px;margin:0 auto}

.settings-section h2{font-size:10px;letter-spacing:3px;color:var(--sub);text-transform:uppercase;font-weight:800;margin-bottom:10px;padding-left:4px}

.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}
.stat-card{
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  padding:16px;display:flex;flex-direction:column;gap:4px;
}
.stat-val{font-family:'Press Start 2P',monospace;font-size:16px;color:var(--green)}
.stat-val.yellow{color:var(--yellow)}
.stat-val.red{color:var(--red)}
.stat-label{font-size:10px;color:var(--sub);font-weight:700;letter-spacing:1px}

.setting-card{
  background:var(--card);border:1px solid var(--border);border-radius:16px;
  overflow:hidden;
}
.setting-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px;border-bottom:1px solid var(--border);
}
.setting-row:last-child{border-bottom:none}
.setting-left{display:flex;align-items:center;gap:12px}
.setting-icon{font-size:20px;width:28px;text-align:center}
.setting-info .stg-name{font-size:14px;font-weight:800;color:var(--text)}
.setting-info .stg-sub{font-size:11px;color:var(--sub);margin-top:1px}

/* Toggle switch */
.toggle-sw{width:50px;height:28px;border-radius:14px;background:#333;position:relative;cursor:pointer;transition:background .2s;border:1px solid rgba(255,255,255,0.1);flex-shrink:0}
.toggle-sw::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;background:#888;top:2px;left:2px;transition:all .2s;box-shadow:0 2px 4px rgba(0,0,0,0.4)}
.toggle-sw.on{background:rgba(57,255,110,0.25);border-color:rgba(57,255,110,0.4)}
.toggle-sw.on::after{left:24px;background:var(--green);box-shadow:0 0 8px rgba(57,255,110,0.6)}

/* Version / credits */
.credits{text-align:center;padding:20px;color:var(--sub);font-size:11px;letter-spacing:1px;line-height:2}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST NOTIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;top:max(20px, env(safe-area-inset-top, 20px));left:50%;
  transform:translateX(-50%) translateY(-100px);
  background:var(--card2);border:1px solid var(--border);
  border-radius:100px;padding:12px 24px;
  font-size:13px;font-weight:800;color:var(--text);
  z-index:200;white-space:nowrap;letter-spacing:.5px;
  box-shadow:0 8px 30px rgba(0,0,0,0.5);
  transition:transform .35s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;
}
.toast.show{transform:translateX(-50%) translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:480px){
  .btn-play{font-size:20px;padding:22px}
  .ctrl-icon{font-size:38px}
}
</style>
</head>
<body>

<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="homeScreen">
  <div class="home-bg-grid"></div>
  <div class="home-glow"></div>
  <div class="home-content">

    <div style="display:flex;justify-content:center;align-items:center;gap:16px;width:100%">
      <div class="mascot-wrap">
        <canvas id="mascotCanvas" width="120" height="120"></canvas>
        <div class="mascot-shadow"></div>
      </div>
    </div>

    <div class="title-block">
      <div class="game-title">DINO<br>RUSH</div>
      <div class="game-sub">Enhanced Edition</div>
    </div>

    <div class="best-pill">
      <span class="trophy">ğŸ†</span>
      <div>
        <div class="best-label">Meilleur score</div>
        <div class="best-val" id="homeBest">00000</div>
      </div>
    </div>

    <div class="home-buttons">
      <button class="btn-play" id="homePlayBtn">
        <span class="btn-play-icon">â–¶</span> JOUER
      </button>
      <div class="home-row">
        <button class="btn-secondary" id="homeShopBtn">
          <span class="ico">ğŸ¨</span>
          <span class="lbl">BOUTIQUE</span>
        </button>
        <button class="btn-secondary" id="homeSettingsBtn">
          <span class="ico">âš™ï¸</span>
          <span class="lbl">PROFIL</span>
        </button>
      </div>
    </div>

    <div class="coins-badge">
      <span class="coin-ico">ğŸª™</span>
      <span class="coin-amt" id="homeCoins">0</span>
      <span class="coin-lbl">PIÃˆCES</span>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="gameScreen">

  <!-- HUD -->
  <div class="game-hud">
    <div class="hud-score">
      <span class="hud-label">SCORE</span>
      <span id="scoreVal">00000</span>
    </div>
    <div class="hud-right">
      <div class="hud-hi">ğŸ† <span id="hiVal">00000</span></div>
      <div class="lives-row">
        <span class="life-heart" id="h1">â¤ï¸</span>
        <span class="life-heart" id="h2">â¤ï¸</span>
        <span class="life-heart" id="h3">â¤ï¸</span>
      </div>
    </div>
  </div>

  <!-- Canvas -->
  <div class="canvas-container" id="canvasWrap">
    <canvas id="gameCanvas"></canvas>

    <div class="speed-bar">
      <span class="speed-label">VITESSE</span>
      <span class="speed-val" id="speedVal">1.0Ã—</span>
    </div>

    <div class="powerup-overlay">
      <div class="pu-badge" id="pu-shield">ğŸ›¡ï¸<div class="pu-timer" id="pu-shield-timer" style="width:0%"></div></div>
      <div class="pu-badge" id="pu-magnet">ğŸ§²<div class="pu-timer" id="pu-magnet-timer" style="width:0%"></div></div>
      <div class="pu-badge" id="pu-slow">â±ï¸<div class="pu-timer" id="pu-slow-timer" style="width:0%"></div></div>
      <div class="pu-badge" id="pu-star">â­<div class="pu-timer" id="pu-star-timer" style="width:0%"></div></div>
    </div>

    <!-- Start overlay -->
    <div class="game-overlay show" id="startOverlay">
      <div class="overlay-card">
        <span class="overlay-icon">ğŸ¦•</span>
        <div class="overlay-title green">PRÃŠT ?</div>
        <div style="margin:16px 0;color:var(--sub);font-size:13px;line-height:1.8;font-weight:700">
          Saute par-dessus les obstacles<br>et bats ton record !
        </div>
        <div class="tap-hint">â†“ APPUIE SUR SAUTER</div>
      </div>
    </div>

    <!-- Game over overlay -->
    <div class="game-overlay" id="gameOverOverlay">
      <div class="overlay-card">
        <span class="overlay-icon">ğŸ’€</span>
        <div class="overlay-title red">GAME OVER</div>
        <div class="overlay-score" id="goScore">00000</div>
        <div class="overlay-sub">SCORE FINAL</div>
        <div id="newRecordBadge" class="new-record" style="display:none">ğŸ† NOUVEAU RECORD !</div>
        <div style="margin-top:20px;display:flex;gap:10px">
          <button style="flex:1;padding:14px;border-radius:14px;border:1.5px solid var(--border);background:var(--card2);color:var(--sub);font-size:13px;font-weight:800;cursor:pointer;font-family:Nunito,sans-serif" id="goHomeBtn">ğŸ  ACCUEIL</button>
          <button style="flex:2;padding:14px;border-radius:14px;border:none;background:linear-gradient(135deg,#39FF6E,#00c44f);color:#0a1a0f;font-size:14px;font-weight:900;cursor:pointer;font-family:Nunito,sans-serif;box-shadow:0 4px 0 #0f6b35" id="goRetryBtn">â–¶ REJOUER</button>
        </div>
      </div>
    </div>

    <!-- Pause overlay -->
    <div class="game-overlay" id="pauseOverlay">
      <div class="overlay-card">
        <span class="overlay-icon">â¸</span>
        <div class="overlay-title" style="color:var(--blue)">PAUSE</div>
        <div style="margin:20px 0;display:flex;flex-direction:column;gap:10px">
          <button style="width:100%;padding:16px;border-radius:14px;border:none;background:linear-gradient(135deg,#39FF6E,#00c44f);color:#0a1a0f;font-size:15px;font-weight:900;cursor:pointer;font-family:Nunito,sans-serif;box-shadow:0 4px 0 #0f6b35" id="pauseResumeBtn">â–¶ REPRENDRE</button>
          <button style="width:100%;padding:16px;border-radius:14px;border:1.5px solid var(--border);background:var(--card2);color:var(--sub);font-size:14px;font-weight:800;cursor:pointer;font-family:Nunito,sans-serif" id="pauseHomeBtn">ğŸ  ACCUEIL</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls bar -->
  <div class="controls-bar">
    <button class="pause-btn" id="pauseBtn">â¸</button>
    <button class="ctrl-btn btn-jump" id="jumpBtn">
      <span class="ctrl-icon">â¬†ï¸</span>
      <span class="ctrl-label">SAUTER</span>
    </button>
    <button class="ctrl-btn btn-duck" id="duckBtn">
      <span class="ctrl-icon">â¬‡ï¸</span>
      <span class="ctrl-label">SE BAISSER</span>
    </button>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHOP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="shopScreen">
  <div class="shop-header">
    <button class="back-btn" id="shopBackBtn">â†</button>
    <div class="shop-title">BOUTIQUE</div>
    <div class="shop-coins">
      <span class="sc-ico">ğŸª™</span>
      <span class="sc-amt" id="shopCoins">0</span>
    </div>
  </div>
  <div class="shop-body">
    <div class="shop-section">
      <h2>Dinosaures</h2>
      <div class="skins-grid" id="skinGrid"></div>
    </div>
    <div class="shop-section">
      <h2>TraÃ®nÃ©es</h2>
      <div class="trails-grid" id="trailGrid"></div>
    </div>
    <div style="height:20px"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS / PROFILE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="settingsScreen">
  <div class="settings-header">
    <button class="back-btn" id="settingsBackBtn">â†</button>
    <div class="settings-title">PROFIL</div>
    <div style="width:38px"></div>
  </div>
  <div class="settings-body">

    <div class="settings-section">
      <h2>Statistiques</h2>
      <div class="stat-grid">
        <div class="stat-card">
          <div class="stat-val" id="stBest">0</div>
          <div class="stat-label">ğŸ† MEILLEUR</div>
        </div>
        <div class="stat-card">
          <div class="stat-val yellow" id="stCoins">0</div>
          <div class="stat-label">ğŸª™ PIÃˆCES TOTALES</div>
        </div>
        <div class="stat-card">
          <div class="stat-val red" id="stGames">0</div>
          <div class="stat-label">ğŸ® PARTIES</div>
        </div>
        <div class="stat-card">
          <div class="stat-val" id="stSkins" style="color:var(--purple)">0</div>
          <div class="stat-label">ğŸ¨ SKINS</div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <h2>ParamÃ¨tres</h2>
      <div class="setting-card">
        <div class="setting-row">
          <div class="setting-left">
            <span class="setting-icon">ğŸŒ™</span>
            <div class="setting-info">
              <div class="stg-name">ThÃ¨me Nuit</div>
              <div class="stg-sub">ArriÃ¨re-plan sombre profond</div>
            </div>
          </div>
          <div class="toggle-sw on" id="tgNight" onclick="toggle('night')"></div>
        </div>
        <div class="setting-row">
          <div class="setting-left">
            <span class="setting-icon">âœ¨</span>
            <div class="setting-info">
              <div class="stg-name">Particules</div>
              <div class="stg-sub">Effets visuels & traÃ®nÃ©es</div>
            </div>
          </div>
          <div class="toggle-sw on" id="tgParticles" onclick="toggle('particles')"></div>
        </div>
        <div class="setting-row">
          <div class="setting-left">
            <span class="setting-icon">ğŸ”Š</span>
            <div class="setting-info">
              <div class="stg-name">Sons</div>
              <div class="stg-sub">Effets sonores du jeu</div>
            </div>
          </div>
          <div class="toggle-sw on" id="tgSound" onclick="toggle('sound')"></div>
        </div>
        <div class="setting-row">
          <div class="setting-left">
            <span class="setting-icon">ğŸ“³</span>
            <div class="setting-info">
              <div class="stg-name">Vibration</div>
              <div class="stg-sub">Retour haptique mobile</div>
            </div>
          </div>
          <div class="toggle-sw on" id="tgVib" onclick="toggle('vib')"></div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <h2>Danger Zone</h2>
      <div class="setting-card">
        <div class="setting-row" style="cursor:pointer" onclick="resetScores()">
          <div class="setting-left">
            <span class="setting-icon">ğŸ”„</span>
            <div class="setting-info">
              <div class="stg-name" style="color:var(--yellow)">RÃ©initialiser les scores</div>
              <div class="stg-sub">Remet le meilleur score Ã  0</div>
            </div>
          </div>
          <span style="color:var(--sub);font-size:18px">â€º</span>
        </div>
      </div>
    </div>

    <div class="credits">
      DINO RUSH v2.0<br>
      Enhanced Edition<br>
      <span style="color:rgba(255,255,255,0.15)">Made with â¤ï¸</span>
    </div>
  </div>
</div>

</div><!-- end #app -->

<!-- Buy confirm sheet -->
<div class="buy-confirm" id="buyConfirm">
  <div class="buy-sheet">
    <h3 id="buySheetTitle">Acheter ?</h3>
    <div class="buy-preview" id="buySheetPreview"></div>
    <div style="text-align:center">
      <div style="font-size:13px;color:var(--sub);font-weight:700;margin-bottom:4px">Prix</div>
      <div style="font-size:22px;color:var(--yellow);font-weight:900" id="buySheetPrice">0 ğŸª™</div>
    </div>
    <div class="buy-row">
      <button class="buy-cancel" onclick="closeBuySheet()">Annuler</button>
      <button class="buy-confirm-btn" id="buyConfirmBtn">Acheter !</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SKINS = [
  {id:'classic',name:'DINO',rarity:'common',price:0,body:'#39FF6E',leg:'#1aa355',eye:'#0a1a0f',glow:'#39FF6E'},
  {id:'crimson',name:'SANG',rarity:'rare',price:150,body:'#FF3E6C',leg:'#b81a42',eye:'#fff',glow:'#FF3E6C'},
  {id:'cyber',name:'CYBER',rarity:'rare',price:200,body:'#4FC3F7',leg:'#0288d1',eye:'#FFD93D',glow:'#4FC3F7'},
  {id:'lava',name:'LAVE',rarity:'epic',price:350,body:'#FF6B35',leg:'#c44200',eye:'#FFD93D',glow:'#FF6B35'},
  {id:'gold',name:'OR',rarity:'epic',price:400,body:'#FFD93D',leg:'#e6a800',eye:'#0a0a0f',glow:'#FFD93D'},
  {id:'void',name:'NÃ‰ANT',rarity:'epic',price:500,body:'#9C27B0',leg:'#6a0080',eye:'#FF4081',glow:'#9C27B0'},
  {id:'galaxy',name:'GALAXIE',rarity:'legendary',price:800,body:null,galaxy:true,leg:'#6a0080',eye:'#FFD93D',glow:'#ff6ec7'},
  {id:'chrome',name:'CHROME',rarity:'legendary',price:1200,body:null,chrome:true,leg:'#909090',eye:'#00FFFF',glow:'#c0c0c0'},
];

const TRAILS=[
  {id:'none',name:'AUCUNE',rarity:'common',price:0,dots:[]},
  {id:'green',name:'VERT',rarity:'common',price:80,dots:['#39FF6E','#00c44f','#00ff99']},
  {id:'fire',name:'FEU',rarity:'rare',price:200,dots:['#FF6B35','#FFD93D','#FF3E6C']},
  {id:'ice',name:'GLACE',rarity:'rare',price:220,dots:['#B3E5FC','#81D4FA','#4FC3F7']},
  {id:'purple',name:'OMBRE',rarity:'epic',price:380,dots:['#B388FF','#9C27B0','#E040FB']},
  {id:'rainbow',name:'ARC-EN-CIEL',rarity:'epic',price:450,dots:['#FF3E6C','#FFD93D','#39FF6E','#4FC3F7','#B388FF']},
  {id:'gold',name:'DORÃ‰E',rarity:'legendary',price:900,dots:['#FFD700','#FFA000','#FFECB3']},
  {id:'star',name:'Ã‰TOILES',rarity:'legendary',price:1100,dots:['#ffffff','#FFD93D','#B388FF','#4FC3F7']},
];

const RARITY_COLORS={common:'#888',rare:'#4FC3F7',epic:'#B388FF',legendary:'#FFD93D'};

let G={
  hiScore:+localStorage.getItem('dr_hi')||0,
  coins:+localStorage.getItem('dr_coins')||0,
  ownedSkins:JSON.parse(localStorage.getItem('dr_skins')||'["classic"]'),
  ownedTrails:JSON.parse(localStorage.getItem('dr_trails')||'["none"]'),
  skin:localStorage.getItem('dr_skin')||'classic',
  trail:localStorage.getItem('dr_trail')||'none',
  gamesPlayed:+localStorage.getItem('dr_games')||0,
  totalCoins:+localStorage.getItem('dr_totalcoins')||0,
  settings:JSON.parse(localStorage.getItem('dr_settings')||'{"night":true,"particles":true,"sound":true,"vib":true}'),
};

function save(){
  localStorage.setItem('dr_hi',G.hiScore);
  localStorage.setItem('dr_coins',G.coins);
  localStorage.setItem('dr_skins',JSON.stringify(G.ownedSkins));
  localStorage.setItem('dr_trails',JSON.stringify(G.ownedTrails));
  localStorage.setItem('dr_skin',G.skin);
  localStorage.setItem('dr_trail',G.trail);
  localStorage.setItem('dr_games',G.gamesPlayed);
  localStorage.setItem('dr_totalcoins',G.totalCoins);
  localStorage.setItem('dr_settings',JSON.stringify(G.settings));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('homePlayBtn').onclick=()=>{showScreen('gameScreen');startGame()};
document.getElementById('homeShopBtn').onclick=()=>{showScreen('shopScreen');renderShop()};
document.getElementById('homeSettingsBtn').onclick=()=>{showScreen('settingsScreen');renderSettings()};
document.getElementById('shopBackBtn').onclick=()=>{showScreen('homeScreen');updateHomeUI()};
document.getElementById('settingsBackBtn').onclick=()=>{showScreen('homeScreen');updateHomeUI()};
document.getElementById('goHomeBtn').onclick=()=>{endGame();showScreen('homeScreen');updateHomeUI()};
document.getElementById('goRetryBtn').onclick=()=>{startGame()};
document.getElementById('pauseHomeBtn').onclick=()=>{endGame();showScreen('homeScreen');updateHomeUI()};
document.getElementById('pauseResumeBtn').onclick=resumeGame;
document.getElementById('pauseBtn').onclick=pauseGame;

function updateHomeUI(){
  document.getElementById('homeBest').textContent=String(G.hiScore).padStart(5,'0');
  document.getElementById('homeCoins').textContent=G.coins;
}
updateHomeUI();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
let W,H,GROUND;

function resizeCanvas(){
  const wrap=document.getElementById('canvasWrap');
  W=canvas.width=wrap.clientWidth;
  H=canvas.height=wrap.clientHeight;
  GROUND=H-44;
}
window.addEventListener('resize',()=>{resizeCanvas();if(!GS.running)renderIdle()});
resizeCanvas();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let GS={running:false,paused:false,score:0,speed:5,frame:0,lives:3,coins:0,lastMilestone:0};
let raf=null;
const obstacles=[],gameCoins=[],powerDrops=[],particles=[];
let obstTimer=80,coinTimer=120,puTimer=300;
let pterFrame=0,pterTimer=0;

const POWERUP_ICONS={shield:'ğŸ›¡ï¸',magnet:'ğŸ§²',slow:'â±ï¸',star:'â­'};
const POWERUP_COLORS={shield:'#4FC3F7',magnet:'#FF6EC7',slow:'#39FF6E',star:'#FFD93D'};
const activePU={shield:false,magnet:false,slow:false,star:false};
const puTimers={};
const puRemain={shield:0,magnet:0,slow:0,star:0};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DINO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dino={
  x:80,y:0,vy:0,jumping:false,canDbl:true,ducking:false,
  runF:0,runT:0,invT:0,trail:[],
  get h(){return this.ducking?26:52},
  get w(){return this.ducking?58:42},

  jump(){
    if(!this.jumping){this.vy=-15.5;this.jumping=true;this.canDbl=true;sfx('jump');vib(25);return}
    if(this.canDbl&&this.y<GROUND-10){this.vy=-13;this.canDbl=false;sfx('jump');burst(this.x,this.y-20,'#39FF6E',6);vib(20)}
  },
  duck(on){this.ducking=on},

  update(){
    this.vy+=0.72;
    this.y+=this.vy;
    if(this.y>=GROUND){this.y=GROUND;this.vy=0;this.jumping=false;this.canDbl=true}
    this.runT++;
    if(this.runT>7){this.runF^=1;this.runT=0}
    if(this.invT>0)this.invT--;

    // trail
    const trailDef=TRAILS.find(t=>t.id===G.trail);
    if(trailDef&&trailDef.dots.length>0&&G.settings.particles){
      const col=trailDef.dots[Math.floor(Math.random()*trailDef.dots.length)];
      this.trail.push({x:this.x-8,y:this.y-(this.ducking?12:28),life:18,col,sz:Math.random()*3.5+1.5});
    }
    this.trail=this.trail.filter(p=>{p.life--;return p.life>0});
  },

  box(){
    const margin=8;
    return{x:this.x-this.w/2+margin,y:this.y-this.h+2,w:this.w-margin*2,h:this.h-4};
  },

  draw(ctx){
    const sk=SKINS.find(s=>s.id===G.skin)||SKINS[0];
    // trail
    this.trail.forEach(p=>{
      ctx.globalAlpha=p.life/18;
      ctx.fillStyle=p.col;
      ctx.shadowBlur=8;ctx.shadowColor=p.col;
      ctx.beginPath();ctx.arc(p.x,p.y,p.sz*(p.life/18),0,Math.PI*2);ctx.fill();
    });
    ctx.globalAlpha=1;ctx.shadowBlur=0;

    if(this.invT>0&&Math.floor(this.invT/4)%2===0)return;

    ctx.save();
    ctx.shadowBlur=18;ctx.shadowColor=sk.glow||'#39FF6E';

    const setFill=()=>{
      if(sk.galaxy){
        const g=ctx.createLinearGradient(this.x-22,this.y-55,this.x+20,this.y);
        g.addColorStop(0,'#ff6ec7');g.addColorStop(0.5,'#B388FF');g.addColorStop(1,'#4FC3F7');
        ctx.fillStyle=g;
      }else if(sk.chrome){
        const g=ctx.createLinearGradient(this.x-22,this.y-55,this.x+20,this.y);
        g.addColorStop(0,'#fff');g.addColorStop(0.5,'#ccc');g.addColorStop(1,'#888');
        ctx.fillStyle=g;
      }else{ctx.fillStyle=sk.body}
    };

    if(this.ducking){
      setFill();
      rr(ctx,this.x-29,this.y-26,58,26,7);ctx.fill();
      ctx.shadowBlur=0;ctx.fillStyle=sk.leg||'#1aa355';
      rr(ctx,this.x-18,this.y-10,11,10,3);ctx.fill();
      rr(ctx,this.x+6,this.y-10,11,10,3);ctx.fill();
      ctx.fillStyle=sk.eye||'#0a1a0f';
      ctx.beginPath();ctx.arc(this.x+22,this.y-16,4.5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff';
      ctx.beginPath();ctx.arc(this.x+24,this.y-18,1.8,0,Math.PI*2);ctx.fill();
    }else{
      // Body
      setFill();
      rr(ctx,this.x-21,this.y-52,38,34,8);ctx.fill();
      // Head
      rr(ctx,this.x-13,this.y-76,34,28,8);ctx.fill();
      // Jaw
      ctx.shadowBlur=0;ctx.fillStyle=sk.leg||'#1aa355';
      rr(ctx,this.x+8,this.y-58,12,7,3);ctx.fill();
      // Arm
      rr(ctx,this.x+10,this.y-40,8,13,4);ctx.fill();
      // Legs
      if(this.runF===0){
        rr(ctx,this.x-14,this.y-18,11,18,3);ctx.fill();
        rr(ctx,this.x+2,this.y-10,11,10,3);ctx.fill();
      }else{
        rr(ctx,this.x-14,this.y-10,11,10,3);ctx.fill();
        rr(ctx,this.x+2,this.y-18,11,18,3);ctx.fill();
      }
      // Eye
      ctx.fillStyle=sk.eye||'#0a1a0f';
      ctx.shadowBlur=5;ctx.shadowColor='#fff';
      ctx.beginPath();ctx.arc(this.x+13,this.y-65,5.5,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fff';ctx.shadowBlur=0;
      ctx.beginPath();ctx.arc(this.x+15,this.y-67,2,0,Math.PI*2);ctx.fill();
    }

    // Shield aura
    if(activePU.shield){
      ctx.strokeStyle='#4FC3F7';ctx.lineWidth=2.5;
      ctx.shadowBlur=14;ctx.shadowColor='#4FC3F7';
      ctx.globalAlpha=0.55+Math.sin(Date.now()/200)*.15;
      ctx.beginPath();ctx.arc(this.x,this.y-26,45,0,Math.PI*2);ctx.stroke();
      ctx.globalAlpha=1;
    }
    if(activePU.star){
      ctx.fillStyle='#FFD93D';ctx.shadowBlur=28;ctx.shadowColor='#FFD93D';
      ctx.globalAlpha=0.12+Math.sin(Date.now()/150)*.04;
      ctx.beginPath();ctx.arc(this.x,this.y-26,52,0,Math.PI*2);ctx.fill();
      ctx.globalAlpha=1;
    }
    ctx.restore();
  }
};

function rr(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);
  ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);
  ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.closePath();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OBSTACLE TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OBS_TYPES=[
  {id:'cs',w:16,h:34,
    draw(ctx,x,y){drawCactus(ctx,x,y,1)}},
  {id:'cm',w:26,h:44,
    draw(ctx,x,y){drawCactus(ctx,x,y,2)}},
  {id:'cl',w:40,h:50,
    draw(ctx,x,y){drawCactus(ctx,x,y,3)}},
  {id:'rock',w:28,h:20,
    draw(ctx,x,y){drawRock(ctx,x,y)}},
  {id:'spk',w:46,h:26,
    draw(ctx,x,y){drawSpikes(ctx,x,y)}},
  {id:'ptl',w:46,h:18,flying:true,flyH:70,
    draw(ctx,x,y,f){drawPtero(ctx,x,y,f)}},
  {id:'pth',w:46,h:18,flying:true,flyH:110,
    draw(ctx,x,y,f){drawPtero(ctx,x,y,f)}},
];

function drawCactus(ctx,x,y,s){
  ctx.save();
  const w=8+s*4,h=24+s*8;
  ctx.fillStyle='#1DB954';ctx.shadowBlur=6;ctx.shadowColor='#1DB95450';
  rr(ctx,x-w/2,y-h,w,h,3);ctx.fill();
  if(s>=2){
    rr(ctx,x-w/2-10,y-h+10,10,14,3);ctx.fill();
    rr(ctx,x-w/2-10,y-h+8,18,7,3);ctx.fill();
  }
  if(s>=3){
    rr(ctx,x+w/2,y-h+16,10,12,3);ctx.fill();
    rr(ctx,x+w/2-10,y-h+12,18,7,3);ctx.fill();
  }
  ctx.restore();
}

function drawRock(ctx,x,y){
  ctx.save();ctx.fillStyle='#5c6770';ctx.shadowBlur=4;ctx.shadowColor='#0005';
  ctx.beginPath();
  ctx.moveTo(x-14,y);ctx.lineTo(x-18,y-9);ctx.lineTo(x-8,y-20);
  ctx.lineTo(x+6,y-20);ctx.lineTo(x+16,y-10);ctx.lineTo(x+14,y);ctx.closePath();ctx.fill();
  ctx.fillStyle='#8a96a0';
  ctx.beginPath();ctx.moveTo(x-8,y-18);ctx.lineTo(x+2,y-16);ctx.lineTo(x+8,y-9);ctx.lineTo(x-2,y-7);ctx.closePath();ctx.fill();
  ctx.restore();
}

function drawSpikes(ctx,x,y){
  ctx.save();ctx.fillStyle='#FF3E6C';ctx.shadowBlur=7;ctx.shadowColor='#FF3E6C60';
  for(let i=0;i<4;i++){
    const sx=x-20+i*14,sh=10+(i%2)*10;
    ctx.beginPath();ctx.moveTo(sx,y);ctx.lineTo(sx+7,y);ctx.lineTo(sx+3.5,y-sh);ctx.closePath();ctx.fill();
  }
  ctx.restore();
}

function drawPtero(ctx,x,y,frame){
  ctx.save();ctx.fillStyle='#B388FF';ctx.shadowBlur=8;ctx.shadowColor='#B388FF50';
  rr(ctx,x-11,y-7,22,14,5);ctx.fill();
  ctx.fillStyle='#D1AAFF';rr(ctx,x+9,y-4,13,5,2);ctx.fill();
  ctx.fillStyle='#0a0a1a';ctx.beginPath();ctx.arc(x+5,y-3,2.5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(x+6,y-4,1,0,Math.PI*2);ctx.fill();
  const flap=frame%2===0?-9:9;
  ctx.fillStyle='#9C27B0';
  ctx.beginPath();ctx.moveTo(x-9,y-3);ctx.lineTo(x-34,y-15+flap);ctx.lineTo(x-34,y-3+flap);ctx.lineTo(x-9,y+4);ctx.closePath();ctx.fill();
  ctx.fillStyle='#7B1FA2';
  ctx.beginPath();ctx.moveTo(x-9,y-1);ctx.lineTo(x-26,y+4+flap);ctx.lineTo(x-24,y+8+flap);ctx.lineTo(x-9,y+4);ctx.closePath();ctx.fill();
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND ELEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const clouds=[];
const groundDec=[];
function initBg(){
  clouds.length=0;groundDec.length=0;
  for(let i=0;i<5;i++) clouds.push({x:Math.random()*W,y:15+Math.random()*55,w:55+Math.random()*75,spd:0.3+Math.random()*.5});
  for(let i=0;i<14;i++) groundDec.push({x:Math.random()*W*2.5,t:Math.random()<.5?'r':'b',sz:Math.random()*5+2});
}
initBg();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARTICLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function burst(x,y,col,n=8){
  if(!G.settings.particles)return;
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*3.5+1;
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:28+Math.random()*12,max:40,col,sz:Math.random()*3+1});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO (Web Audio)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let AC=null;
function getAC(){if(!AC)AC=new(window.AudioContext||window.webkitAudioContext)();return AC}
function sfx(type){
  if(!G.settings.sound)return;
  try{
    const ac=getAC(),o=ac.createOscillator(),g=ac.createGain();
    o.connect(g);g.connect(ac.destination);
    const t=ac.currentTime;
    if(type==='jump'){o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(420,t+.1);g.gain.setValueAtTime(.14,t);g.gain.exponentialRampToValueAtTime(.001,t+.18);o.start(t);o.stop(t+.18)}
    else if(type==='coin'){o.frequency.setValueAtTime(660,t);o.frequency.setValueAtTime(880,t+.06);g.gain.setValueAtTime(.1,t);g.gain.exponentialRampToValueAtTime(.001,t+.2);o.start(t);o.stop(t+.2)}
    else if(type==='death'){o.type='sawtooth';o.frequency.setValueAtTime(330,t);o.frequency.exponentialRampToValueAtTime(60,t+.5);g.gain.setValueAtTime(.18,t);g.gain.exponentialRampToValueAtTime(.001,t+.5);o.start(t);o.stop(t+.5)}
    else if(type==='pu'){o.type='sine';o.frequency.setValueAtTime(440,t);o.frequency.setValueAtTime(660,t+.1);o.frequency.setValueAtTime(880,t+.2);g.gain.setValueAtTime(.11,t);g.gain.exponentialRampToValueAtTime(.001,t+.35);o.start(t);o.stop(t+.35)}
    else if(type==='mile'){o.type='square';o.frequency.setValueAtTime(550,t);o.frequency.setValueAtTime(880,t+.12);g.gain.setValueAtTime(.07,t);g.gain.exponentialRampToValueAtTime(.001,t+.4);o.start(t);o.stop(t+.4)}
  }catch(e){}
}
function vib(ms){if(G.settings.vib&&navigator.vibrate)navigator.vibrate(ms)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POWERUP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function activatePU(type){
  sfx('pu');vib([30,10,30]);
  const DURATIONS={shield:320,magnet:420,slow:260,star:360};
  const dur=DURATIONS[type];
  activePU[type]=true;
  clearTimeout(puTimers[type]);
  puTimers[type]=setTimeout(()=>{activePU[type]=false;updatePUHUD()},dur*(1000/60));
  puRemain[type]=dur;
  updatePUHUD();
  toast(`${POWERUP_ICONS[type]} ${type.toUpperCase()} ACTIVÃ‰ !`);
  // animate timer bar
  const bar=document.getElementById('pu-'+type+'-timer');
  let r=dur;
  const iv=setInterval(()=>{
    r--;
    if(!activePU[type]||r<=0){clearInterval(iv);if(bar)bar.style.width='0%';updatePUHUD();return}
    if(bar)bar.style.width=(r/dur*100)+'%';
  },1000/60);
}
function updatePUHUD(){
  ['shield','magnet','slow','star'].forEach(t=>{
    const el=document.getElementById('pu-'+t);
    if(el)el.classList.toggle('active',activePU[t]);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COLLISION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function overlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y}

function checkCollisions(){
  if(dino.invT>0||activePU.star)return;
  const db=dino.box();
  for(const o of obstacles){
    const oh=o.h||20;
    const ob={x:o.x-o.w/2+5,y:o.y-oh+5,w:o.w-10,h:oh-10};
    if(overlap(db,ob)){
      if(activePU.shield){activePU.shield=false;updatePUHUD();dino.invT=80;burst(dino.x,dino.y-20,'#4FC3F7',14);toast('ğŸ›¡ï¸ BOUCLIER BRISÃ‰');vib(60);return}
      loseLife();return;
    }
  }
}

function loseLife(){
  GS.lives--;updateLivesHUD();sfx('death');vib([60,30,60]);
  burst(dino.x,dino.y-25,'#FF3E6C',20);
  if(GS.lives<=0){triggerGameOver()}
  else{dino.invT=140;toast(`â¤ï¸ ${GS.lives} vie${GS.lives>1?'s':''} restante${GS.lives>1?'s':''}`)}
}

function updateLivesHUD(){
  ['h1','h2','h3'].forEach((id,i)=>{
    const el=document.getElementById(id);
    if(el)el.classList.toggle('lost',i>=GS.lives);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MILESTONES=[100,250,500,1000,2000,3500,5000,10000];

function gameLoop(){
  if(!GS.running||GS.paused)return;
  update();render();
  raf=requestAnimationFrame(gameLoop);
}

function update(){
  GS.frame++;
  const slow=activePU.slow?0.48:1;

  // Score & coins
  GS.score+=slow;
  if(GS.frame%6===0){GS.coins++;GS.totalCoins++}

  // Speed
  GS.speed=Math.min(5+Math.floor(GS.score/180)*0.35,20);

  const s=GS.speed*slow;

  // HUD
  document.getElementById('scoreVal').textContent=String(Math.floor(GS.score)).padStart(5,'0');
  document.getElementById('hiVal').textContent=String(G.hiScore).padStart(5,'0');
  document.getElementById('speedVal').textContent=(GS.speed/5).toFixed(1)+'Ã—';

  // Milestone
  const ms=MILESTONES.find(m=>Math.floor(GS.score)>=m&&m>GS.lastMilestone);
  if(ms){GS.lastMilestone=ms;sfx('mile');floatText(`${ms} âœ¦`,GROUND-100,'#FFD93D')}

  // Dino
  dino.update();

  // Obstacles
  obstTimer--;
  if(obstTimer<=0){
    let pool=OBS_TYPES.filter(o=>!o.flying||GS.speed>6.5);
    const o=pool[Math.floor(Math.random()*pool.length)];
    const oy=o.flying?(GROUND-o.flyH):GROUND;
    obstacles.push({...o,x:W+60,y:oy,frm:0,frmt:0});
    obstTimer=Math.max(42,80-GS.speed*2.5)+Math.random()*40;
  }
  pterTimer++;if(pterTimer>9){pterFrame^=1;pterTimer=0}
  for(let i=obstacles.length-1;i>=0;i--){
    const o=obstacles[i];o.x-=s;
    o.frmt++;if(o.frmt>9){o.frm^=1;o.frmt=0}
    if(o.x<-120)obstacles.splice(i,1);
  }

  // Coins
  coinTimer--;
  if(coinTimer<=0){
    gameCoins.push({x:W+20,y:GROUND-20-Math.random()*60,angle:0});
    coinTimer=75+Math.random()*55;
  }
  for(let i=gameCoins.length-1;i>=0;i--){
    const c=gameCoins[i];c.x-=s;c.angle+=.06;
    if(activePU.magnet){const dx=dino.x-c.x,dy=(dino.y-20)-c.y,d=Math.hypot(dx,dy);if(d<200){c.x+=dx*.09;c.y+=dy*.09}}
    const db=dino.box();
    if(c.x>db.x&&c.x<db.x+db.w&&c.y>db.y&&c.y<db.y+db.h){
      GS.coins+=5;GS.totalCoins+=5;sfx('coin');burst(c.x,c.y,'#FFD93D',7);floatText('+5ğŸª™',c.y-20,'#FFD93D');
      gameCoins.splice(i,1);continue;
    }
    if(c.x<-30)gameCoins.splice(i,1);
  }

  // Powerup drops
  puTimer--;
  if(puTimer<=0){
    const types=['shield','magnet','slow','star'];
    const type=types[Math.floor(Math.random()*4)];
    powerDrops.push({x:W+20,y:GROUND-75,type,icon:POWERUP_ICONS[type],col:POWERUP_COLORS[type]});
    puTimer=380+Math.random()*280;
  }
  for(let i=powerDrops.length-1;i>=0;i--){
    const p=powerDrops[i];p.x-=s;
    p.y=GROUND-75+Math.sin(Date.now()/420)*14;
    const db=dino.box();
    if(p.x>db.x&&p.x<db.x+db.w&&p.y>db.y&&p.y<db.y+db.h){activatePU(p.type);powerDrops.splice(i,1);continue}
    if(p.x<-30)powerDrops.splice(i,1);
  }

  // Particles
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vy+=.15;p.life--;if(p.life<=0)particles.splice(i,1)}

  // Clouds & ground deco scroll
  clouds.forEach(c=>{c.x-=c.spd*slow*.3;if(c.x<-200)c.x=W+80});
  groundDec.forEach(d=>{d.x-=s*.5;if(d.x<-20)d.x+=W*2.5+40});

  checkCollisions();
}

function render(){
  ctx.clearRect(0,0,W,H);
  const night=G.settings.night;

  // Sky
  const sky=ctx.createLinearGradient(0,0,0,H);
  if(night){sky.addColorStop(0,'#07071a');sky.addColorStop(1,'#0f0f28')}
  else{sky.addColorStop(0,'#0d1b2a');sky.addColorStop(1,'#163048')}
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

  // Stars (night only)
  if(night){
    for(let i=0;i<25;i++){
      const sx=(i*137.5)%W,sy=5+(i*89.3)%(GROUND-60);
      const b=.3+.7*Math.sin(Date.now()/600+i);
      ctx.fillStyle=`rgba(255,255,255,${b*.6})`;
      ctx.beginPath();ctx.arc(sx,sy,.8+b*.6,0,Math.PI*2);ctx.fill();
    }
    // Moon
    ctx.fillStyle='rgba(220,230,255,0.12)';ctx.shadowBlur=20;ctx.shadowColor='#fff';
    ctx.beginPath();ctx.arc(W-70,35,16,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;
  }

  // Clouds
  clouds.forEach(c=>{
    ctx.fillStyle=night?'rgba(255,255,255,.04)':'rgba(255,255,255,.09)';
    rr(ctx,c.x,c.y,c.w,20,10);ctx.fill();
    rr(ctx,c.x+c.w*.2,c.y-13,c.w*.55,20,10);ctx.fill();
  });

  // Ground
  const gr=ctx.createLinearGradient(0,GROUND,0,H);
  if(night){gr.addColorStop(0,'#111130');gr.addColorStop(1,'#080818')}
  else{gr.addColorStop(0,'#0d1b30');gr.addColorStop(1,'#081020')}
  ctx.fillStyle=gr;ctx.fillRect(0,GROUND,W,H-GROUND);

  // Ground glow line
  ctx.strokeStyle='rgba(57,255,110,.35)';ctx.lineWidth=1.5;
  ctx.shadowBlur=10;ctx.shadowColor='rgba(57,255,110,.3)';
  ctx.beginPath();ctx.moveTo(0,GROUND);ctx.lineTo(W,GROUND);ctx.stroke();ctx.shadowBlur=0;

  // Ground deco
  groundDec.forEach(d=>{
    if(d.t==='r'){ctx.fillStyle='rgba(255,255,255,0.05)';rr(ctx,d.x,GROUND+4,d.sz*2,d.sz,2);ctx.fill()}
    else{ctx.fillStyle='rgba(57,255,110,0.07)';ctx.beginPath();ctx.arc(d.x,GROUND+3,d.sz,Math.PI,0);ctx.fill()}
  });

  // Game coins
  gameCoins.forEach(c=>{
    ctx.save();ctx.translate(c.x,c.y);ctx.scale(Math.cos(c.angle),1);
    ctx.fillStyle='#FFD93D';ctx.shadowBlur=12;ctx.shadowColor='#FFD93D70';
    ctx.beginPath();ctx.arc(0,0,9,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#FFC107';ctx.beginPath();ctx.arc(0,0,5,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;ctx.restore();
  });

  // Powerup drops
  powerDrops.forEach(p=>{
    const pulse=Math.sin(Date.now()/300);
    ctx.save();
    ctx.shadowBlur=14+pulse*4;ctx.shadowColor=p.col;
    ctx.fillStyle=p.col+'33';ctx.strokeStyle=p.col;ctx.lineWidth=2;
    ctx.beginPath();ctx.arc(p.x,p.y,18,0,Math.PI*2);ctx.fill();ctx.stroke();
    ctx.shadowBlur=0;ctx.font='16px serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(p.icon,p.x,p.y);ctx.restore();
  });

  // Obstacles
  obstacles.forEach(o=>{ctx.save();o.draw(ctx,o.x,o.y,o.frm);ctx.restore()});

  // Particles
  particles.forEach(p=>{
    ctx.globalAlpha=p.life/p.max;ctx.fillStyle=p.col;
    ctx.shadowBlur=7;ctx.shadowColor=p.col;
    ctx.beginPath();ctx.arc(p.x,p.y,p.sz*(p.life/p.max),0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
  });
  ctx.globalAlpha=1;

  // Speed lines (high speed)
  if(GS.speed>13){
    const intens=(GS.speed-13)/7;
    ctx.strokeStyle=`rgba(57,255,110,${intens*.12})`;ctx.lineWidth=1;
    for(let i=0;i<6;i++){
      const ly=20+Math.random()*(GROUND-40);
      ctx.beginPath();ctx.moveTo(Math.random()*W*.7,ly);ctx.lineTo(0,ly);ctx.stroke();
    }
  }

  // Dino
  dino.draw(ctx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IDLE ANIMATION (home/start)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIdle(){
  if(GS.running)return;
  const wrap=document.getElementById('canvasWrap');
  if(!wrap||!canvas.width)return;
  render();
}
let idleRaf;
function idleLoop(){idleRaf=requestAnimationFrame(idleLoop);if(!GS.running){dino.runT++;if(dino.runT>8){dino.runF^=1;dino.runT=0}}}
idleLoop();

// Mascot canvas for home screen
const mc=document.getElementById('mascotCanvas');
const mctx=mc.getContext('2d');
let mascotF=0,mascotT=0;
function drawMascot(){
  mctx.clearRect(0,0,120,120);
  const sk=SKINS.find(s=>s.id===G.skin)||SKINS[0];
  mctx.save();
  mctx.shadowBlur=18;mctx.shadowColor=sk.glow||'#39FF6E';
  const x=60,y=100;
  if(sk.galaxy){const g=mctx.createLinearGradient(38,20,80,100);g.addColorStop(0,'#ff6ec7');g.addColorStop(.5,'#B388FF');g.addColorStop(1,'#4FC3F7');mctx.fillStyle=g}
  else if(sk.chrome){const g=mctx.createLinearGradient(38,20,80,100);g.addColorStop(0,'#fff');g.addColorStop(1,'#888');mctx.fillStyle=g}
  else mctx.fillStyle=sk.body||'#39FF6E';
  // body
  rr(mctx,x-20,y-52,38,34,8);mctx.fill();
  rr(mctx,x-12,y-76,34,28,8);mctx.fill();
  mctx.shadowBlur=0;mctx.fillStyle=sk.leg||'#1aa355';
  rr(mctx,x+8,y-58,12,7,3);mctx.fill();rr(mctx,x+10,y-40,8,13,4);mctx.fill();
  // legs animated
  mascotT++;if(mascotT>10){mascotF^=1;mascotT=0}
  if(mascotF===0){rr(mctx,x-13,y-18,11,18,3);mctx.fill();rr(mctx,x+3,y-10,11,10,3);mctx.fill()}
  else{rr(mctx,x-13,y-10,11,10,3);mctx.fill();rr(mctx,x+3,y-18,11,18,3);mctx.fill()}
  mctx.fillStyle=sk.eye||'#0a1a0f';mctx.shadowBlur=5;mctx.shadowColor='#fff';
  mctx.beginPath();mctx.arc(x+14,y-65,5.5,0,Math.PI*2);mctx.fill();
  mctx.fillStyle='#fff';mctx.shadowBlur=0;mctx.beginPath();mctx.arc(x+16,y-67,2,0,Math.PI*2);mctx.fill();
  mctx.restore();
}
setInterval(drawMascot,1000/30);drawMascot();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LIFECYCLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  resizeCanvas();initBg();
  GS={running:true,paused:false,score:0,speed:5,frame:0,lives:3,coins:0,lastMilestone:0};
  dino.y=GROUND;dino.vy=0;dino.jumping=false;dino.ducking=false;dino.invT=0;dino.trail=[];
  obstacles.length=0;gameCoins.length=0;powerDrops.length=0;particles.length=0;
  obstTimer=90;coinTimer=130;puTimer=300;pterFrame=0;
  ['shield','magnet','slow','star'].forEach(t=>{activePU[t]=false;clearTimeout(puTimers[t])});
  updatePUHUD();updateLivesHUD();
  document.getElementById('startOverlay').classList.remove('show');
  document.getElementById('gameOverOverlay').classList.remove('show');
  document.getElementById('pauseOverlay').classList.remove('show');
  cancelAnimationFrame(raf);gameLoop();
}

function pauseGame(){
  if(!GS.running||GS.paused)return;
  GS.paused=true;cancelAnimationFrame(raf);
  document.getElementById('pauseOverlay').classList.add('show');
}

function resumeGame(){
  if(!GS.running||!GS.paused)return;
  GS.paused=false;
  document.getElementById('pauseOverlay').classList.remove('show');
  gameLoop();
}

function triggerGameOver(){
  GS.running=false;cancelAnimationFrame(raf);
  G.gamesPlayed++;
  const score=Math.floor(GS.score);
  const isRecord=score>G.hiScore;
  if(isRecord)G.hiScore=score;
  G.coins+=GS.coins;G.totalCoins+=GS.coins;
  save();sfx('death');vib([80,40,80,40,120]);
  document.getElementById('goScore').textContent=String(score).padStart(5,'0');
  document.getElementById('newRecordBadge').style.display=isRecord?'inline-flex':'none';
  document.getElementById('gameOverOverlay').classList.add('show');
  burst(dino.x,dino.y-25,'#FF3E6C',28);render();
}

function endGame(){
  GS.running=false;GS.paused=false;cancelAnimationFrame(raf);
  ['shield','magnet','slow','star'].forEach(t=>{activePU[t]=false;clearTimeout(puTimers[t])});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INPUT HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Jump button
const jumpBtn=document.getElementById('jumpBtn');
jumpBtn.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(!GS.running){startGame();return}
  if(GS.paused)return;
  dino.jump();
},{passive:false});
jumpBtn.addEventListener('mousedown',e=>{
  if(!GS.running){startGame();return}
  if(GS.paused)return;
  dino.jump();
});

// Duck button
const duckBtn=document.getElementById('duckBtn');
duckBtn.addEventListener('touchstart',e=>{e.preventDefault();if(GS.running&&!GS.paused)dino.duck(true)},{passive:false});
duckBtn.addEventListener('touchend',()=>dino.duck(false));
duckBtn.addEventListener('mousedown',()=>{if(GS.running&&!GS.paused)dino.duck(true)});
document.addEventListener('mouseup',()=>dino.duck(false));

// Keyboard
document.addEventListener('keydown',e=>{
  if(['ArrowUp','Space','KeyW'].includes(e.code)){
    e.preventDefault();
    if(!GS.running){if(document.getElementById('gameScreen').classList.contains('active')){startGame()}return}
    if(!GS.paused)dino.jump();
  }
  if(['ArrowDown','KeyS'].includes(e.code)){if(GS.running&&!GS.paused)dino.duck(true)}
  if(['Escape','KeyP'].includes(e.code)){if(GS.running){GS.paused?resumeGame():pauseGame()}}
});
document.addEventListener('keyup',e=>{if(['ArrowDown','KeyS'].includes(e.code))dino.duck(false)});

// Start overlay click (canvas tap)
document.getElementById('startOverlay').addEventListener('touchstart',e=>{e.preventDefault();startGame()},{passive:false});
document.getElementById('startOverlay').addEventListener('click',startGame);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLOAT TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function floatText(text,y,color){
  const wrap=document.getElementById('canvasWrap');
  const el=document.createElement('div');
  el.className='combo-float';
  el.style.top=(y||GROUND-80)+'px';
  el.style.color=color||'#fff';
  el.textContent=text;
  wrap.appendChild(el);
  setTimeout(()=>el.remove(),800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastT;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOP UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let buyTarget=null;

function renderShop(){
  document.getElementById('shopCoins').textContent=G.coins;
  // Skins
  const sg=document.getElementById('skinGrid');sg.innerHTML='';
  SKINS.forEach(sk=>{
    const owned=G.ownedSkins.includes(sk.id);
    const equipped=G.skin===sk.id;
    const tile=document.createElement('div');
    tile.className='skin-tile'+(equipped?' equipped':'')+(owned?'':' locked');

    const rarity=document.createElement('div');
    rarity.className='rarity-pip '+sk.rarity;
    tile.appendChild(rarity);

    const wrap2=document.createElement('div');wrap2.className='skin-canvas-wrap';
    const pc=document.createElement('canvas');pc.width=60;pc.height=55;pc.className='skin-preview-canvas';
    drawSkinPreview(pc.getContext('2d'),sk);
    wrap2.appendChild(pc);tile.appendChild(wrap2);

    const nm=document.createElement('div');nm.className='skin-name';nm.textContent=sk.name;tile.appendChild(nm);

    const rc=document.createElement('div');
    rc.style.cssText=`font-size:9px;font-weight:700;letter-spacing:1px;color:${RARITY_COLORS[sk.rarity]}`;
    rc.textContent=sk.rarity.toUpperCase();tile.appendChild(rc);

    if(equipped){const b=document.createElement('div');b.className='equipped-badge';b.textContent='Ã‰QUIPÃ‰';tile.appendChild(b)}

    if(!owned){
      const lo=document.createElement('div');lo.className='lock-overlay';
      lo.innerHTML=`<span class="lock-ico">ğŸ”’</span><span class="lock-price">${sk.price}ğŸª™</span>`;
      const bb=document.createElement('button');
      bb.style.cssText='margin-top:6px;padding:6px 12px;border:none;border-radius:8px;background:#FFD93D;color:#2a1500;font-size:10px;font-weight:900;cursor:pointer;font-family:Nunito,sans-serif';
      bb.textContent='ACHETER';
      bb.addEventListener('click',e=>{e.stopPropagation();openBuySheet('skin',sk.id)});
      lo.appendChild(bb);tile.appendChild(lo);
    }else if(!equipped){
      tile.addEventListener('click',()=>equipSkin(sk.id));
    }
    sg.appendChild(tile);
  });

  // Trails
  const tg=document.getElementById('trailGrid');tg.innerHTML='';
  TRAILS.forEach(tr=>{
    const owned=G.ownedTrails.includes(tr.id);
    const equipped=G.trail===tr.id;
    const tile=document.createElement('div');
    tile.className='trail-tile'+(equipped?' equipped':'')+(owned?'':' locked');

    const rarity=document.createElement('div');
    rarity.className='rarity-pip '+tr.rarity;rarity.style.position='absolute';rarity.style.top='8px';rarity.style.right='8px';
    tile.style.position='relative';
    tile.appendChild(rarity);

    const dp=document.createElement('div');dp.className='trail-dots-preview';
    if(tr.dots.length===0){dp.innerHTML='<span style="font-size:18px;color:#555">â€”</span>'}
    else{tr.dots.forEach((c,i)=>{const d=document.createElement('div');d.className='t-dot';const sz=7+(tr.dots.length-i)*2;d.style.cssText=`width:${sz}px;height:${sz}px;background:${c};box-shadow:0 0 5px ${c};animation-delay:${i*.15}s`;dp.appendChild(d)})}
    tile.appendChild(dp);

    const nm=document.createElement('div');nm.className='trail-name-small';nm.textContent=tr.name;tile.appendChild(nm);
    const rc=document.createElement('div');rc.style.cssText=`font-size:9px;font-weight:700;color:${RARITY_COLORS[tr.rarity]}`;rc.textContent=tr.rarity.toUpperCase();tile.appendChild(rc);

    if(equipped){const b=document.createElement('div');b.className='equipped-badge';b.style.borderColor='var(--red)';b.style.background='var(--red)';b.textContent='Ã‰QUIPÃ‰';tile.appendChild(b)}

    if(!owned){
      const lo=document.createElement('div');lo.className='lock-overlay';
      lo.innerHTML=`<span class="lock-ico">ğŸ”’</span><span class="lock-price">${tr.price}ğŸª™</span>`;
      const bb=document.createElement('button');
      bb.style.cssText='margin-top:6px;padding:6px 12px;border:none;border-radius:8px;background:#FFD93D;color:#2a1500;font-size:10px;font-weight:900;cursor:pointer;font-family:Nunito,sans-serif';
      bb.textContent='ACHETER';
      bb.addEventListener('click',e=>{e.stopPropagation();openBuySheet('trail',tr.id)});
      lo.appendChild(bb);tile.appendChild(lo);
    }else if(!equipped){
      tile.addEventListener('click',()=>equipTrail(tr.id));
    }
    tg.appendChild(tile);
  });
}

function drawSkinPreview(pctx,sk){
  pctx.save();
  pctx.shadowBlur=10;pctx.shadowColor=sk.glow||'#39FF6E';
  const x=30,y=52;
  if(sk.galaxy){const g=pctx.createLinearGradient(10,4,55,52);g.addColorStop(0,'#ff6ec7');g.addColorStop(.5,'#B388FF');g.addColorStop(1,'#4FC3F7');pctx.fillStyle=g}
  else if(sk.chrome){const g=pctx.createLinearGradient(10,4,55,52);g.addColorStop(0,'#fff');g.addColorStop(1,'#808080');pctx.fillStyle=g}
  else pctx.fillStyle=sk.body||'#39FF6E';
  rr(pctx,x-14,y-32,25,22,6);pctx.fill();
  rr(pctx,x-7,y-48,22,19,6);pctx.fill();
  pctx.shadowBlur=0;pctx.fillStyle=sk.leg||'#1aa355';
  rr(pctx,x-7,y-8,7,8,2);pctx.fill();rr(pctx,x+2,y-8,7,8,2);pctx.fill();
  pctx.fillStyle=sk.eye||'#0a1a0f';pctx.shadowBlur=4;pctx.shadowColor='#fff';
  pctx.beginPath();pctx.arc(x+8,y-41,3.5,0,Math.PI*2);pctx.fill();
  pctx.fillStyle='#fff';pctx.shadowBlur=0;pctx.beginPath();pctx.arc(x+9,y-42,1.2,0,Math.PI*2);pctx.fill();
  pctx.restore();
}

function openBuySheet(category,id){
  buyTarget={category,id};
  const el=document.getElementById('buyConfirm');
  el.classList.add('show');
  if(category==='skin'){
    const sk=SKINS.find(s=>s.id===id);
    document.getElementById('buySheetTitle').textContent=sk.name;
    document.getElementById('buySheetPrice').textContent=sk.price+'ğŸª™';
    const pv=document.getElementById('buySheetPreview');pv.innerHTML='';
    const pc=document.createElement('canvas');pc.width=80;pc.height=65;pc.className='skin-preview-canvas';
    drawSkinPreview(pc.getContext('2d'),sk);pv.appendChild(pc);
  }else{
    const tr=TRAILS.find(t=>t.id===id);
    document.getElementById('buySheetTitle').textContent=tr.name;
    document.getElementById('buySheetPrice').textContent=tr.price+'ğŸª™';
    const pv=document.getElementById('buySheetPreview');pv.innerHTML='';
    const dp=document.createElement('div');dp.className='trail-dots-preview';
    if(tr.dots.length===0){dp.innerHTML='<span style="font-size:24px;color:#555">â€”</span>'}
    else{tr.dots.forEach((c,i)=>{const d=document.createElement('div');d.className='t-dot';const sz=10+(tr.dots.length-i)*2;d.style.cssText=`width:${sz}px;height:${sz}px;background:${c};box-shadow:0 0 8px ${c};animation-delay:${i*.15}s`;dp.appendChild(d)})}
    pv.appendChild(dp);
  }
}

function closeBuySheet(){document.getElementById('buyConfirm').classList.remove('show');buyTarget=null}

document.getElementById('buyConfirmBtn').addEventListener('click',()=>{
  if(!buyTarget)return;
  const{category,id}=buyTarget;
  if(category==='skin'){
    const sk=SKINS.find(s=>s.id===id);
    if(G.coins<sk.price){toast('âŒ Pas assez de piÃ¨ces !');closeBuySheet();return}
    G.coins-=sk.price;G.ownedSkins.push(id);save();
    toast(`âœ… ${sk.name} dÃ©bloquÃ© !`);
  }else{
    const tr=TRAILS.find(t=>t.id===id);
    if(G.coins<tr.price){toast('âŒ Pas assez de piÃ¨ces !');closeBuySheet();return}
    G.coins-=tr.price;G.ownedTrails.push(id);save();
    toast(`âœ… TraÃ®nÃ©e ${tr.name} dÃ©bloquÃ©e !`);
  }
  closeBuySheet();renderShop();updateHomeUI();drawMascot();
});

document.getElementById('buyConfirm').addEventListener('click',e=>{if(e.target===document.getElementById('buyConfirm'))closeBuySheet()});

function equipSkin(id){G.skin=id;save();renderShop();drawMascot();toast('ğŸ¨ Skin Ã©quipÃ© !')}
function equipTrail(id){G.trail=id;dino.trail=[];save();renderShop();toast('âœ¨ TraÃ®nÃ©e Ã©quipÃ©e !')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSettings(){
  document.getElementById('stBest').textContent=String(G.hiScore).padStart(5,'0');
  document.getElementById('stCoins').textContent=G.totalCoins;
  document.getElementById('stGames').textContent=G.gamesPlayed;
  document.getElementById('stSkins').textContent=G.ownedSkins.length;
  ['night','particles','sound','vib'].forEach(k=>{
    const el=document.getElementById('tg'+k[0].toUpperCase()+k.slice(1));
    if(el)el.classList.toggle('on',G.settings[k]);
  });
}

function toggle(key){
  G.settings[key]=!G.settings[key];
  const map={night:'Night',particles:'Particles',sound:'Sound',vib:'Vib'};
  const el=document.getElementById('tg'+map[key]);
  if(el)el.classList.toggle('on',G.settings[key]);
  save();
}

function resetScores(){
  if(confirm('RÃ©initialiser le meilleur score ?')){
    G.hiScore=0;save();renderSettings();toast('ğŸ”„ Scores rÃ©initialisÃ©s');
  }
}

// Initial state
renderSettings();
</script>
</body>
</html>
